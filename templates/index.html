<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>çˆ±ç†è´¢çš„DU</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --accent: #3b82f6;
            --accent2: #6366f1;
            --up: #ef4444;
            --down: #22c55e;
            --text: #f1f5f9;
            --sub: #94a3b8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            position: relative;
        }
        h1 { text-align: center; margin-bottom: 20px; }

        .card, .fund-card {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.35);
            width: 95%;
            max-width: 420px;
            margin: 0 auto 16px auto;
        }
        input {
            padding: 10px;
            width: 100%;
            border-radius: 6px;
            border: none;
            background: #334155;
            color: white;
            margin-bottom: 6px;
            font-size: 14px;
        }
        button {
            padding: 8px 14px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            color: white;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 3px 6px rgba(0,0,0,0.25);
            font-size: 14px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.35); }

        .add-button { background: linear-gradient(45deg, #10b981, #3b82f6); }
        .fund-buttons button { flex:1; border-radius:10px; font-weight:500; transition:0.2s; }
        .fund-buttons button:nth-child(1) { background: linear-gradient(45deg, #3b82f6, #6366f1); }
        .fund-buttons button:nth-child(2) { background: linear-gradient(45deg, #f59e0b, #f97316); }
        .fund-buttons button:nth-child(3) { background: linear-gradient(45deg, #ef4444, #f43f5e); }
        .fund-buttons button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.4); }

        button.period { padding:5px 12px; font-size:13px; background:#334155; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.2); transition:0.2s; }
        button.period.active { background: var(--accent); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        button.period:hover:not(.active){ background:#475569; }

        .nav-bar button { padding:5px 10px; font-size:14px; background: linear-gradient(45deg, #10b981, #3b82f6); border-radius:10px; box-shadow:0 3px 6px rgba(0,0,0,0.25); }
        .nav-bar button:hover { transform:translateY(-1px); box-shadow:0 5px 10px rgba(0,0,0,0.35); }

        #loginPanel .form-row button { flex:1; border-radius:10px; background:linear-gradient(45deg, #3b82f6, #6366f1); }
        #loginPanel .form-row button:hover { transform: translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.35); }

        .grid { display:flex; gap:12px; margin-bottom:16px; flex-wrap: wrap; justify-content: center; }
        .stat-card { padding:10px; text-align:center; flex: 0 0 22%; min-width:80px; border-radius:10px; background: var(--card); }
        .stat-title { font-size:13px; color: var(--sub); }
        .stat-value { font-size:18px; font-weight:600; margin-top:5px; }
        .up { color: var(--up); } .down { color: var(--down); } .blink { animation: blink 1s infinite; }
        @keyframes blink { 0%,50%,100% { opacity:1; } 25%,75% { opacity:0.2; } }
        .small { font-size:12px; color: var(--sub); }
        .loading { text-align:center; padding:10px; color: var(--sub); }
        canvas { margin-top:8px; width:100% !important; height:auto; }

        .fund-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; padding:12px 16px; background:#1e293b; border-radius:12px 12px 0 0; transition:0.2s; }
        .fund-header:hover { background:#27303f; }
        .fund-header-left { display:flex; flex-direction:column; gap:2px; }
        .fund-header-right { display:flex; align-items:center; gap:8px; }
        .fund-title { font-weight:600; }
        .fund-profit { font-weight:600; text-align:right; }
        .arrow { display:inline-block; transition:transform 0.3s; font-weight:bold; }
        .arrow.open { transform:rotate(90deg); }
        .fund-body { display:none; flex-direction:column; gap:8px; background:#0f172a; padding:12px 16px; border-radius:0 0 12px 12px; }
        .fund-buttons { display:flex; gap:8px; margin-top:8px; }
        .fund-buttons button { flex:1; }
        .nav-bar { display:flex; justify-content:space-between; align-items:center; width:100%; max-width:420px; margin-bottom:16px; padding:10px 15px; background: var(--card); border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.3); }
        .nav-bar span { font-weight:600; }
        .form-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
        .form-row input { flex:1; }
        .period-box { display:flex; gap:5px; flex-wrap:wrap; margin-top:5px; }

        /* ==== å…¨å±€ Loading é®ç½© ==== */
        #globalLoading {
            position: fixed;
            top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.6);
            color: #fff;
            font-size:18px;
            display:flex;
            justify-content:center;
            align-items:center;
            z-index:9999;
            display:none;
            flex-direction: column;
        }
        #globalLoading .spinner {
            border:4px solid rgba(255,255,255,0.2);
            border-top:4px solid #3b82f6;
            border-radius:50%;
            width:40px;
            height:40px;
            animation: spin 1s linear infinite;
            margin-bottom:10px;
        }
        @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }

        /* ===== å°å±å¹•é€‚é… ===== */
        @media (max-width: 480px){
            body { padding:10px; }
            .stat-card { flex: 0 0 45%; min-width:45%; margin-bottom:8px; }
            input, button { font-size:13px; padding:6px 10px; }
            .fund-header, .fund-body, .fund-buttons { padding:8px 12px; }
            .fund-body canvas { height: 120px; }
        }
    </style>
    <style></style>
</head>
<body>

<h1>ğŸ“Š çˆ±ç†è´¢çš„DU</h1>

<div id="loginPanel" class="card">
    <h2 style="text-align:center;">ç™»å½• / æ³¨å†Œ</h2>
    <input id="username" placeholder="ç”¨æˆ·å">
    <input id="password" type="password" placeholder="å¯†ç ">
    <div class="form-row">
        <button onclick="loginUser()">ç™»å½•</button>
        <button onclick="registerUser()">æ³¨å†Œ</button>
    </div>
</div>

<div id="app" style="display:none;">
    <div class="nav-bar">
        <span>æ¬¢è¿ï¼Œ<b id="userNameShow"></b></span>
        <button onclick="logoutUser()">é€€å‡º</button>
    </div>

    <div class="grid">
        <div class="stat-card">
            <div class="stat-title">æ€»èµ„äº§</div>
            <div class="stat-value" id="totalAsset">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">æ€»ç›ˆäº</div>
            <div class="stat-value" id="totalProfit">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">æ”¶ç›Šç‡</div>
            <div class="stat-value" id="totalPercent">0%</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">ä»Šæ—¥æ€»æ”¶ç›Š</div>
            <div class="stat-value" id="todayProfit">0</div>
        </div>
    </div>

    <div class="card">
        <h3>æ·»åŠ æŒä»“</h3>
        <div class="form-row">
            <input id="code" placeholder="åŸºé‡‘ä»£ç ">
            <input id="price" placeholder="ä¹°å…¥ä»·æ ¼">
            <input id="amount" placeholder="ä»½é¢">
            <button class="add-button" onclick="addFund()">æ·»åŠ </button>
        </div>
    </div>

    <h3>æŒä»“åˆ—è¡¨</h3>
    <div id="list"></div>

    <h3>èµ„äº§å æ¯”</h3>
    <canvas id="pieChart" height="200"></canvas>
</div>

<!-- å…¨å±€ Loading é®ç½© -->
<div id="globalLoading">
    <div class="spinner"></div>
    <div>æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å€™...</div>
</div>

<script>
let chartCache = {}, pieChart = null;

// ==== Loading å·¥å…·å‡½æ•° ====
function showLoading(msg="åŠ è½½ä¸­...") {
    const l = document.getElementById("globalLoading");
    l.style.display = "flex";
    l.querySelector("div:last-child").innerText = msg;
}
function hideLoading(){ document.getElementById("globalLoading").style.display="none"; }

// ==== åŒ…è£… fetch è¯·æ±‚ï¼Œè‡ªåŠ¨æ˜¾ç¤º Loading ====
async function fetchWithLoading(url, options={}, msg="åŠ è½½ä¸­...") {
    try { showLoading(msg);
        let res = await fetch(url, options);
        hideLoading();
        return res;
    } catch(e){ hideLoading(); alert("è¯·æ±‚å¤±è´¥ï¼š"+e); throw e; }
}

// ==== é¡µé¢åˆå§‹åŒ– ====
window.onload = async () => {
    let d = await (await fetchWithLoading("/me", {}, "æ­£åœ¨æ£€æŸ¥ç™»å½•çŠ¶æ€")).json();
    if(d.logged_in) showApp(d.username);
};

function showApp(username){
    loginPanel.style.display = "none";
    app.style.display = "block";
    userNameShow.innerText = username;
    loadData();
}

async function registerUser(){
    let d = await (await fetchWithLoading("/register", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({username:username.value, password:password.value})
    }, "æ³¨å†Œä¸­...")).json();
    if(d.error) alert(d.error); else alert("æ³¨å†ŒæˆåŠŸ");
}

async function loginUser(){
    let d = await (await fetchWithLoading("/login", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({username:username.value, password:password.value})
    }, "ç™»å½•ä¸­...")).json();
    if(d.error) alert(d.error); else showApp(d.username);
}

function logoutUser(){ fetch("/logout").then(()=>location.reload()); }

async function addFund(){
    // åŸºç¡€è¾“å…¥
    let c = code.value.trim();
    let p = parseFloat(price.value);
    let a = parseFloat(amount.value);

    if (!c) {
        alert("è¯·è¾“å…¥åŸºé‡‘ä»£ç ");
        return;
    }
    if (isNaN(p) || p <= 0) {
        alert("è¯·è¾“å…¥æ­£ç¡®çš„ä¹°å…¥ä»·æ ¼");
        return;
    }
    if (isNaN(a) || a <= 0) {
        alert("è¯·è¾“å…¥æ­£ç¡®çš„ä»½é¢");
        return;
    }

    // å‘é€è¯·æ±‚
    let d = await (await fetchWithLoading("/add", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({code: c, buy_price: p, amount: a})
    }, "æ·»åŠ æŒä»“ä¸­...")).json();

    if(d.error) alert(d.error);
    else loadData();
}


async function updatePosition(code, delta, price){
    await fetchWithLoading("/update/"+code, {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({delta,buy_price:price})
    }, "æ›´æ–°æŒä»“ä¸­...");
    loadData();
}
</script>

<script>
// ==== æŒä»“æ“ä½œ ====
function addShares(code){
    let n = parseFloat(prompt("åŠ ä»“ä»½é¢"));
    if(!n || n<=0) return;
    let p = parseFloat(prompt("åŠ ä»“ä»·æ ¼"));
    if(!p || p<=0) return;
    updatePosition(code, n, p);
}

function reduceShares(code){
    let n = parseFloat(prompt("å‡ä»“ä»½é¢"));
    if(n>0) updatePosition(code, -n);
}

function clearShares(code, amount){
    if(confirm("ç¡®è®¤æ¸…ä»“?")) updatePosition(code, -amount);
}

// ==== æ•°æ®åŠ è½½ä¸åˆ·æ–° ====
async function refreshRealtime(){
    let data = await (await fetchWithLoading("/holdings", {}, "åˆ·æ–°æ•°æ®ä¸­...")).json();

    totalAsset.innerText = data.total_asset;
    totalProfit.innerText = (data.total_profit>=0?'+':'') + data.total_profit;
    totalPercent.innerText = (data.total_percent>=0?'+':'') + data.total_percent + '%';
    todayProfit.innerText = data.today_profit>=0? '+'+data.today_profit : data.today_profit;

    todayProfit.className = "stat-value " + (data.today_profit>=0?"up":"down");
    totalProfit.className = "stat-value " + (data.total_profit>=0?"up":"down");
    totalPercent.className = "stat-value " + (data.total_percent>=0?"up":"down");

    data.funds.forEach(f=>{
        let card = document.getElementById("fund_"+f.code);
        if(!card) return;
        card.querySelector(".fund-profit").innerHTML = `${f.profit} (${f.percent>=0?'+':''}${f.percent}%)`;
        card.querySelector(".fund-profit").className = `fund-profit ${f.percent>=0?"up blink":"down blink"}`;
        card.querySelector(".holding").innerHTML = `æŒæœ‰é‡‘é¢: ${f.holding}`;
        card.querySelector(".realtime").innerHTML = `å½“å‰ä¼°å€¼: ${f.current} | ä»Šæ—¥æ¶¨è·Œ: ${f.gszzl}%`;
        card.querySelector(".today-profit").innerHTML = `ä»Šæ—¥æ”¶ç›Š: ${f.today_profit>=0?'+':''}${f.today_profit}`;
    });
    updatePie(data.funds);
}

async function loadData(){
    list.innerHTML = "<div class='loading'>åŠ è½½ä¸­...</div>";
    let data = await (await fetchWithLoading("/holdings", {}, "åŠ è½½æŒä»“ä¸­...")).json();

    totalAsset.innerText = data.total_asset;
    totalProfit.innerText = (data.total_profit>=0?'+':'') + data.total_profit;
    totalPercent.innerText = (data.total_percent>=0?'+':'') + data.total_percent + '%';
    todayProfit.innerText = data.today_profit>=0? '+'+data.today_profit : data.today_profit;

    todayProfit.className = "stat-value " + (data.today_profit>=0?"up":"down");
    totalProfit.className = "stat-value " + (data.total_profit>=0?"up":"down");
    totalPercent.className = "stat-value " + (data.total_percent>=0?"up":"down");

    renderFunds(data.funds);
    updatePie(data.funds);
}

// ==== æ¸²æŸ“æŒä»“å¡ç‰‡ ====
function renderFunds(funds){
    list.innerHTML = "";
    funds.forEach(f=>{
        let div = document.createElement("div");
        div.className = "fund-card";
        div.id = "fund_"+f.code;
        div.innerHTML = `
<div class="fund-header">
    <div class="fund-header-left">
        <span class="fund-title">${f.name} (${f.code})</span>
        <span class="small holding">æŒæœ‰é‡‘é¢: ${f.holding}</span>
        <span class="small realtime">å½“å‰ä¼°å€¼: ${f.current} | ä»Šæ—¥æ¶¨è·Œ: ${f.gszzl}%</span>
        <span class="small today-profit">ä»Šæ—¥æ”¶ç›Š: ${f.today_profit>=0?'+':''}${f.today_profit}</span>
    </div>
    <div class="fund-header-right">
        <span class="fund-profit ${f.percent>=0?'up blink':'down blink'}">${f.profit} (${f.percent>=0?'+':''}${f.percent}%)</span>
        <span class="arrow">â–¶</span>
    </div>
</div>
<div class="fund-buttons">
    <button onclick="addShares('${f.code}')">åŠ ä»“</button>
    <button onclick="reduceShares('${f.code}')">å‡ä»“</button>
    <button onclick="clearShares('${f.code}',${f.amount})">æ¸…ä»“</button>
</div>
<div class="fund-body">
    <div class="period-box" id="period_${f.code}">
        <button class="period" onclick="changePeriod('${f.code}','1m',this)">1æœˆ</button>
        <button class="period active" onclick="changePeriod('${f.code}','3m',this)">3æœˆ</button>
        <button class="period" onclick="changePeriod('${f.code}','6m',this)">6æœˆ</button>
        <button class="period" onclick="changePeriod('${f.code}','1y',this)">1å¹´</button>
    </div>
    <canvas id="chart_${f.code}" height="120"></canvas>
</div>`;
        list.appendChild(div);

        let header = div.querySelector(".fund-header");
        let body = div.querySelector(".fund-body");
        let arrow = header.querySelector(".arrow");
        body.style.display = "none";
        header.addEventListener("click", ()=>{
            if(body.style.display === "none"){
                body.style.display = "flex";
                arrow.classList.add("open");
                loadHistory(f.code,getActivePeriod(f.code));
            }else{
                body.style.display = "none";
                arrow.classList.remove("open");
            }
        });
    });
}

// ==== å‘¨æœŸé€‰æ‹© ====
function getActivePeriod(code){
    let box = document.getElementById("period_"+code);
    for(let btn of box.children) if(btn.classList.contains("active")) return btn.innerText.replace(/[^\d]/g,'')+'m';
    return "3m";
}

function changePeriod(code, period, btn){
    let box = document.getElementById("period_"+code);
    [...box.children].forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    let chartDiv = document.getElementById("fund_"+code).querySelector(".fund-body");
    if(chartDiv.style.display==="flex") loadHistory(code, period);
}

// ==== åŠ è½½å†å²å›¾è¡¨ ====
async function loadHistory(code, period){
    let data = await (await fetchWithLoading(`/history/${code}/${period}`, {}, "åŠ è½½å†å²æ•°æ®ä¸­...")).json();
    if(!data.length) return;
    let canvas = document.getElementById("chart_"+code);
    let ctx = canvas.getContext("2d");
    if(chartCache[code]) chartCache[code].destroy();

    let first = data[0].value, last = data[data.length-1].value, isUp = last>=first;
    let gradient = ctx.createLinearGradient(0,0,0,200);
    gradient.addColorStop(0, isUp?"rgba(239,68,68,0.4)":"rgba(34,197,94,0.4)");
    gradient.addColorStop(1,"rgba(0,0,0,0)");

    chartCache[code] = new Chart(ctx,{
        type:'line',
        data:{
            labels:data.map(d=>d.date),
            datasets:[{
                data:data.map(d=>d.value),
                borderColor:isUp?"#ef4444":"#22c55e",
                backgroundColor:gradient,
                fill:true,
                tension:0.3,
                pointRadius:0
            }]
        },
        options:{plugins:{legend:{display:false}},scales:{x:{display:false}}}
    });
}

// ==== é¥¼å›¾æ›´æ–° ====
function updatePie(funds){
    if(pieChart) pieChart.destroy();
    pieChart = new Chart(document.getElementById("pieChart"),{
        type:'doughnut',
        data:{labels:funds.map(f=>f.name), datasets:[{data:funds.map(f=>f.current*f.amount)}]}
    });
}

// ==== è‡ªåŠ¨åˆ·æ–° ====
setInterval(()=>{ if(app.style.display=="block") refreshRealtime(); }, 30000);

</script>

</body>
</html>
